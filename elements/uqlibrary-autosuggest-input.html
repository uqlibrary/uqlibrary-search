<link rel="import" href="elements.html">

<!--
`<uqlibrary-autosuggest-input>` is a simple element that displays search functionality of UQ Library

Example:

  <uqlibrary-autosuggest-input></uqlibrary-autosuggest-input>

@demo

@demo demo/index.html Demo of uqlibrary-autosuggest-input
-->
<dom-module id="uqlibrary-autosuggest-input">
  <template>
    <style is="custom-style" include="common-styles">
      :host {
        font-family: var(--font-family);
        font-size: var(--body-font-size);
        position: relative;
      }

      #inputKeyword {
        background-color: var(--secondary-color-light);
        border-radius: 3px;
      }

      #menuSuggestions {
        border-radius: 3px;
        @apply(--shadow-elevation-2dp);
        width: 99%
      }

      .recent-search {
        color: var(--theme-color);
      }
    </style>

    <iron-a11y-keys target="[[_inputKeywordTarget]]" keys="enter" on-keys-pressed="_activated"></iron-a11y-keys>
    <iron-a11y-keys target="[[_inputKeywordTarget]]" keys="tab" on-keys-pressed="_closeSuggestions"></iron-a11y-keys>
    <iron-a11y-keys target="[[_inputKeywordTarget]]" keys="down" on-keys-pressed="_selectFirstItem"></iron-a11y-keys>

    <iron-a11y-keys target="[[_suggestionsTarget]]" keys="tab" on-keys-pressed="_closeSuggestions"></iron-a11y-keys>

    <paper-input id="inputKeyword" label="[[label]]" value="{{keyword}}" on-focus="_keywordFocused" on-tap="_keywordFocused">
    </paper-input>

    <uqlibrary-iron-dropdown id="menuSuggestions" no-auto-focus="true"
                             horizontal-align="left" vertical-align="top" position-absolute="true"
                             horizontal-offset="3" vertical-offset="60" tabindex="-1">

      <paper-listbox id="listSuggestions" on-iron-activate="_suggestionSelected" class="dropdown-content" no-auto-focus="true" tabindex="-1">
        <template is="dom-repeat" items="{{suggestions}}">
          <paper-item tabindex="-1" class$="{{_recentSearchClass(item.recent)}} " no-auto-focus="true"> [[item.name]] </paper-item>
        </template>
      </paper-listbox>

    </uqlibrary-iron-dropdown>

  </template>

  <script>
    (function () {
      Polymer({
        is: 'uqlibrary-autosuggest-input',

        properties: {
          keyword: {
            type: String,
            observer: '_keywordChanged',
            notify: true
          },

          label: {
            type: String
          },

          enableAutosuggest: {
            type: Object,
            value: true
          },

          suggestions: {
            type: Array,
            observer: '_suggestionsChanged'
          },

          selectedSuggestion: {
            type: Object,
            value: null
          },

          _inputKeywordTarget: {
            type: Object,
            value: function () {
              return this.$.inputKeyword;
            }
          },

          _suggestionsTarget: {
            type: Object,
            value: function() {
              return this.$.listSuggestions;
            }
          }
        },

        _keywordFocused: function() {
          this.selectedSuggestion = null;
          if (!this.enableAutosuggest || this.keyword.length <= 2) {
            this.$.menuSuggestions.close();
          } else if (this.suggestions && this.suggestions.length > 0) {
            this.$.menuSuggestions.open();
          }
        },

        _keywordChanged: function(newValue, oldValue) {
          this.selectedSuggestion = null;
          if (!this.enableAutosuggest || this.keyword.length <= 2) {
            this.$.menuSuggestions.close();
          }
        },

        _suggestionsChanged: function () {
          this.async(function () {
            if (this.suggestions && this.suggestions.length > 0) {
              if (!this.$.menuSuggestions.opened)
                this.$.menuSuggestions.open();
            }
            else
              this.$.menuSuggestions.close();
          }, 100);
        },

        _activated: function(e) {
          this.$.menuSuggestions.close();
          this.fire('activated', this.selectedSuggestion ? this.selectedSuggestion : this.keyword);
          this.suggestions = [];
        },

        _suggestionSelected: function (e) {
          this.selectedSuggestion = this.suggestions[e.detail.selected];
          this._activated();
        },

        _selectFirstItem: function (e) {
          this.async(function () {
            if (this.$.menuSuggestions.opened) {
              this.$.listSuggestions.focus();
            }
          }, 100);
        },

        _closeSuggestions: function (e) {
          this.async(function () {
            this.$.menuSuggestions.close();
          }, 100);
        },

        _recentSearchClass: function(isRecent) {
          return isRecent ? 'recent-search' : '';
        },

        setFocus: function() {
          this.$.inputKeyword.focus();
        },

        ready: function() {
        }

      });
    })();
  </script>
</dom-module>
