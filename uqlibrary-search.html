<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-dropdown/paper-dropdown.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-input/paper-input-decorator.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../core-input/core-input.html">
<link rel="import" href="../core-a11y-keys/core-a11y-keys.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<!--
Element providing library search.

##### Example

    <uqlibrary-search></uqlibrary-search>

@element uqlibrary-search
@blurb Element providing library search.
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-search
-->
<polymer-element name="uqlibrary-search" horizontal layout>

  <template>
    <link rel="stylesheet" href="uqlibrary-search.css">

    <core-a11y-keys target="{{$.search}}" keys="up down right enter esc tab" on-keys-pressed="{{onSearchKeys}}"></core-a11y-keys>

    <core-ajax id="ajax"
               url="{{ajaxQuery}}"
               on-core-response="{{ajaxQuerySuggestionsLoaded}}"
               handleAs="json">
    </core-ajax>

    <div>
      <paper-dropdown-menu label="Search">
        <paper-dropdown class="dropdown">
          <core-selector selected="{{selectedFilter}}" id="filterSelector">
            <template repeat="{{filters}}">
              <paper-item>{{name}}</paper-item>
            </template>
          </core-selector>
        </paper-dropdown>
      </paper-dropdown-menu>
    </div>

    <div flex id="search">
      <paper-input-decorator label="{{placeholder}}">
        <label for="searchInput"></label>
        <div id="mask">{{searchTextMask}}</div>
        <input id="searchInput"
               is="core-input"
               aria-label="{{placeholder}}"
               value="{{searchText}}">
        <paper-dropdown id="autosuggest"
                        class="no-padding"
                        relatedTarget="{{$.searchInput}}"
                        autoFocusDisabled="true">
          <core-selector selected="{{selectedSuggestion}}" selectedAttribute="" id="suggestionSelector">
            <template repeat="{{suggestions}}">
              <paper-item on-tap="{{onTapSuggestion}}">{{name}}</paper-item>
            </template>
          </core-selector>
        </paper-dropdown>
      </paper-input-decorator>
    </div>

    <div>
      <paper-icon-button icon="search" title="search" on-tap="{{search}}"></paper-icon-button>
    </div>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-search', {
        ajaxQuery: '',
        selectedFilter: 0,
        placeholder: '',
        searchText: '',
        selectedSuggestion: 0,
        searchTextMask: '',
        searching: false,
        previousKey: '',

        summonApi: 'https://d3nm82zk9ronst.cloudfront.net/metadata/suggest/suggest',
        lrApi: 'https://app.library.uq.edu.au/api/search_suggestions?type=learning_resource',
        examsApi: 'https://app.library.uq.edu.au/api/search_suggestions?type=exam_paper',
        databaseApi: 'https://app.library.uq.edu.au/api/search_suggestions?type=database',
        summon: 'http://uq.summon.serialssolutions.com/search?q=',
        exams: 'https://www.library.uq.edu.au/exams/papers.php?stub=',
        lr: 'http://lr.library.uq.edu.au/search?q=',
        database: 'https://www.library.uq.edu.au/resources/database/#/?title=',
        journals: 'https://app.library.uq.edu.au/#/journals?S=AC_T_B&C=',
        catalogue: 'https://library.uq.edu.au/search~S7/X?search=',

        created: function () {
          this.filters = [
            { name: 'Search',
              type: 'all',
              desc: 'Find books, articles, databases, conferences and more',
              subtext: 'Books, articles, databases and more',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t',
              autoSuggest: true,
              api: this.summonApi,
              help: [
                {name: 'Search help', url: 'https://www.library.uq.edu.au/search'},
                {name: 'Advanced search', url: 'http://uq.summon.serialssolutions.com/#!/advanced'}
              ] },
            { name: 'Books',
              type: 'books',
              desc: 'Enter a keyword, title, author, etc',
              subtext: 'Books and book chapters',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Book%20%2F%20eBook,f%7CContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t%7CContentType,Book%20Chapter,f',
              autoSuggest: true,
              api: this.summonApi,
              help: [
                {name: 'Search help', url: 'https://www.library.uq.edu.au/search'},
                {name: 'Advanced search', url: 'http://uq.summon.serialssolutions.com/#!/advanced'}
              ] },
            { name: 'Journal articles',
              type: 'journal_articles',
              desc: 'Enter a keyword, article title, author, publication, etc',
              subtext: 'Journal articles, conference papers, working papers',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t%7CContentType,Journal%20Article,f%7CContentType,Magazine%20Article,f',
              autoSuggest: true,
              api: this.summonApi,
              help: [
                {name: 'Search help', url: 'https://www.library.uq.edu.au/search'},
                {name: 'Advanced search', url: 'http://uq.summon.serialssolutions.com/#!/advanced'}
              ] },
            { name: 'Multimedia',
              type: 'multimedia',
              desc: 'Enter keyword, title, cast, crew, composer, artist, etc',
              subtext: 'Video, audio, images, art, etc',
              url: this.summon,
              urlAppend: '&fvf=ContentType,Newspaper%20Article,t%7CContentType,Book%20Review,t%7CContentType,Audio%20Recording,f%7CContentType,Spoken%20Word%20Recording,f%7CContentType,Video%20Recording,f%7CContentType,Streaming%20Video,f%7CContentType,Slide,f%7CContentType,Photograph,f%7CContentType,Music%20Recording,f%7CContentType,Music%20Score,f%7CContentType,Painting,f%7CContentType,Sheet%20Music,f%7CContentType,Poster,f%7CContentType,Art,f%7CContentType,Compact%20Disc,f%7CContentType,Drawing,f%7CContentType,Graphic%20Arts,f%7CContentType,Image,f%7CContentType,Kit,f',
              autoSuggest: true,
              api: this.summonApi,
              help: [
                {name: 'Search help', url: 'https://www.library.uq.edu.au/search'},
                {name: 'Advanced search', url: 'http://uq.summon.serialssolutions.com/#!/advanced'}
              ]  },
            { name: 'Journals',
              type: 'journals',
              desc: 'Enter journal or newspaper title',
              subtext: 'Find a specific journal or newspaper by title',
              url: this.journals,
              autoSuggest: true,
              api: this.summonApi,
              help: [
                {name: 'Browse journals', url: 'https://app.library.uq.edu.au/#/journals'}
              ]  },
            { name: 'Databases',
              type: 'databases',
              desc: 'Enter a keyword or database name',
              subtext: 'Go to a specific research database',
              url: this.database,
              autoSuggest: true,
              api: this.databaseApi,
              help: [
                {name: 'Database help', url: 'https://www.library.uq.edu.au/v/6559'},
                {name: 'Browse databases', url: 'https://www.library.uq.edu.au/resources/database/#/'}
              ]  },
            { name: 'Catalogue',
              type: 'catalogue',
              desc: 'Enter a keyword, title, author, etc',
              subtext: 'Detailed information about Library holdings',
              url: this.catalogue,
              autoSuggest: false,
              help: [
                {name: 'Advanced catalogue search', url: 'https://library.uq.edu.au/search~S7/X'}
              ]  },
            { name: 'Exam papers',
              type: 'exam_papers',
              desc: 'Enter a course code',
              anchor : ['exams', 'exampapers'],
              subtext: 'Past exams from previous semesters',
              url: this.exams,
              autoSuggest: true,
              api: this.examsApi,
              help: [
                {name: 'Browse courses', url: 'https://www.library.uq.edu.au/exams/search.html'}
              ]  },
            { name: 'Course reading lists',
              type: 'learning_resources',
              desc: 'Enter a course code',
              anchor: ['learningresources'],
              subtext: 'Reading lists and resources for your course',
              url: this.lr, autoSuggest: true,
              api: this.lrApi,
              help: [
                {name: 'Browse courses', url: 'http://lr.library.uq.edu.au/index.html?browse'}
              ]  }
          ];
          this.placeholder = this.filters[this.selectedFilter].desc;
          this.suggestions = [];
        },

        ready: function () {
          this.$.searchInput.focus();
        },

        ajaxQueryChanged: function () {
          this.selectedSuggestion = -1;
          if (! this.$.ajax.loading) {
            this.$.ajax.go();
          }
        },

        ajaxQuerySuggestionsLoaded: function () {
          try {
            this.suggestions = this.$.ajax.response.result;
            this.async(function () {
              if (this.suggestions.length > 1 && !this.searching) {
                this.$.autosuggest.opened = true;
                if (this.searchText.length > 3) {
                  this.searchTextMask = this.suggestions[0].name;
                } else {
                  this.searchTextMask = '';
                }
              } else {
                this.$.autosuggest.opened = false;
              }
            }, 100);
          } catch (e) {}
        },

        selectedFilterChanged: function () {
          this.placeholder = this.filters[this.selectedFilter].desc;
          this.$.searchInput.focus();
        },

        searchTextChanged: function () {
          if (! this.searchText.length || this.searching) {
            this.$.autosuggest.opened = false;
            this.searchTextMask = '';
            return;
          }
          if (this.searchTextMask.indexOf(this.searchText) === -1) {
            this.searchTextMask = '';
          }
          var url = this.filters[this.selectedFilter].api;
          url += (url.indexOf('?') === -1) ? '?' : '&';
          this.ajaxQuery = url + 'prefix=' + encodeURIComponent(this.searchText);
        },

        onSearchKeys: function (ev) {
          if (ev.detail.key === 'down') {
            this.selectedSuggestion++;
            this.searchTextMask = this.suggestions[this.selectedSuggestion].name;
          }
          else if (ev.detail.key === 'up' && this.selectedSuggestion > 0) {
            this.selectedSuggestion--;
            this.searchTextMask = this.suggestions[this.selectedSuggestion].name;
          }
          else if (ev.detail.key === 'enter') {
            if (this.selectedSuggestion >= 0 &&
              this.previousKey &&
              (this.previousKey === 'up' || this.previousKey === 'down')
            ) {
              this.selectedSuggestion = -1;
              this.searchText = this.searchTextMask;
            }
            this.search();
          }
          else if (ev.detail.key === 'esc') {
            this.selectedSuggestion = -1;
            this.$.autosuggest.opened = false;
            this.searchTextMask = '';
          }
          else if ((ev.detail.key === 'tab' || ev.detail.key === 'right') && this.searchTextMask.length) {
            this.selectedSuggestion = 0;
            this.searchText = this.searchTextMask;
          }
          this.previousKey = ev.detail.key;
        },

        onTapSuggestion: function () {
          this.async(function () {
            this.searchText = this.suggestions[this.selectedSuggestion].name;
            this.search();
          }, 100);
        },

        search: function () {
          if (this.searching) {
            return;
          }
          this.searching = true;
          this.$.autosuggest.opened = false;
          this.searchTextMask = '';
          console.log('Searching: ' + this.searchText);
          var filter = this.filters[this.selectedFilter];
          var url = filter.url + encodeURIComponent(this.searchText);
          if (filter.urlAppend) {
            url += filter.urlAppend;
          }
          document.location.href = url;
        }

      });
    })();
  </script>

</polymer-element>
